name: apps and images

on:
  push:
    branches:
      - '**'
    tags:
      - v*
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: jinks-demo
  JINKS_IMAGE: ghcr.io/eeditiones/jinks

jobs:
  test-jinks:
    name: Test Jinks Image
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        EXIST_BASE: [6.4.0]
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      - name: Build Jinks image for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            EXIST_VERSION=${{ matrix.EXIST_BASE }}
          load: true
          tags: exist-db
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
      - name: Start docker image
        run: docker run --publish 8080:8080 --name db --detach exist-db
      - name: Run Cypress e2e test
        uses: cypress-io/github-action@v7
        with:
          browser: firefox
      - name: Retrieve eXist log
        if: failure()
        run: docker cp db:/exist/logs/exist.log .
      - name: Publish log as artifact
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: jinks-deploy-exist-${{ matrix.EXIST_BASE }}-log
          path: ./exist.log
      - name: Stop docker
        run: docker stop db || true

  push-jinks:
    name: Push Jinks Image
    needs: test-jinks
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v6
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern=v{{major}}
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Add latest tag for releases
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "${{ steps.meta.outputs.tags }}\nghcr.io/${{ github.repository }}:latest" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        id: tags_with_latest
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push Jinks image
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v')
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          build-args: |
            PUBLISHER_VERSION=main
            EXIST_VERSION=6.4.0
          builder: ${{ steps.buildx.outputs.name }}
          push: true
          sbom: true
          tags: ${{ steps.tags_with_latest.outputs.tags || steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

  generate-apps:
    name: Generate Demo Apps
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 11

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Jinks from source
        run: ant

      - name: Pull jinks base image
        run: docker pull ${JINKS_IMAGE}:latest

      - name: Start jinks container
        run: |
          docker run -d \
            --name jinks-server \
            -p 8080:8080 \
            -v ${{ github.workspace }}/build:/exist/autodeploy \
            ${JINKS_IMAGE}:latest

      - name: Wait for server to start
        timeout-minutes: 10
        run: |
          echo "Waiting for server to start..."
          until docker logs jinks-server 2>&1 | grep -q "Server has started"; do
            echo "Still waiting..."
            sleep 4
          done

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'

      - name: Install jinks-cli
        run: npm install -g @teipublisher/jinks-cli

      - name: Generate tei-publisher app
        working-directory: demo
        run: jinks create -c tp_config.json

      - name: Generate tp-serafin app
        working-directory: demo
        run: jinks create -c ser_config.json

      - name: Generate tp-workbench app
        working-directory: demo
        run: jinks create -c workbench_config.json

      - name: Verify deployed apps
        run: jinks list

      - name: Extract XAR files for generated apps
        working-directory: demo
        run: |
          jinks run tei-publisher download
          jinks run tp-serafin download
          jinks run tp-workbench download

      - name: List generated XAR files
        working-directory: demo
        run: |
          echo "Generated XAR files:"
          ls -lh *.xar || echo "No XAR files found!"

      - name: Commit container for test jobs
        run: |
          docker commit jinks-server temp/jinks-server:$GITHUB_SHA
          mkdir -p path/to/artifacts
          docker save temp/jinks-server:$GITHUB_SHA > path/to/artifacts/docker-image.tar

      - name: Upload container artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-artifact
          path: path/to/artifacts
          retention-days: 3

      - name: Upload XAR artifacts
        uses: actions/upload-artifact@v6
        with:
          name: demo-apps-xars
          path: demo/*.xar
          retention-days: 30

      - name: Stop jinks container
        if: always()
        run: docker stop jinks-server || true

  deploy-jinks-demo:
    name: Deploy Jinks Demo Image
    needs: [push-jinks, generate-apps, run-tests-for-tei-publisher, run-tests-for-tp-workbench, run-tests-for-tp-serafin]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx

      - name: Download XAR artifacts
        uses: actions/download-artifact@v7
        with:
          name: demo-apps-xars
          path: demo/

      - name: Verify XAR files
        working-directory: demo
        run: |
          echo "XAR files to include in image:"
          ls -lh *.xar
          if [ ! -f "tei-publisher.xar" ] || [ ! -f "tp-serafin.xar" ] || [ ! -f "tp-workbench.xar" ]; then
            echo "Error: Missing required XAR files"
            exit 1
          fi

      - name: Set JINKS_VERSION
        id: jv
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-demo
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern=v{{major}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Add latest tag for releases
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "${{ steps.meta.outputs.tags }}\nghcr.io/${{ github.repository }}-demo:latest" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        id: tags_with_latest

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push demo apps image
        timeout-minutes: 25
        uses: docker/build-push-action@v6
        with:
          context: demo
          file: demo/Dockerfile.demo
          platforms: linux/amd64,linux/arm64
          build-args: |
            JINKS_VERSION=${{ steps.jv.outputs.version }}
          builder: ${{ steps.buildx.outputs.name }}
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}
          sbom: true
          tags: ${{ steps.tags_with_latest.outputs.tags || steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}-demo:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}-demo:buildcache,mode=max

  run-tests-for-tei-publisher:
    name: Run tests on tei-publisher
    runs-on: ubuntu-latest
    needs: generate-apps
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run Cypress tests on tei-publisher
        uses: ./.github/actions/cypress-test-for-demo-app
        with:
          app-name: tei-publisher

  run-tests-for-tp-workbench:
    name: Run tests on tp-workbench
    runs-on: ubuntu-latest
    needs: generate-apps
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run Cypress tests on tp-workbench
        uses: ./.github/actions/cypress-test-for-demo-app
        with:
          app-name: tp-workbench

  run-tests-for-tp-serafin:
    name: Run tests on tp-serafin
    runs-on: ubuntu-latest
    needs: generate-apps
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run Cypress tests on tp-serafin
        uses: ./.github/actions/cypress-test-for-demo-app
        with:
          app-name: tp-serafin
