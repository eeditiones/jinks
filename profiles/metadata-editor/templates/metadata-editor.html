<template>
    [% template scripts %]
    [% if exists($context?doc) and $context?features?metadata-editor?enabled %]
    <script type="module" src="[[ $context-path ]]/resources/scripts/metadata-editor.js"></script>
    [% endif %]
	[% endtemplate %]


	[% template after %]
    [% if exists($context?doc) and $context?features?metadata-editor?enabled %]
	<div>
      <style>
		/* Make sure Fore actually hides irrelevant stuff */
		fx-case:not(.selected-case),
        .deselected-case
		[nonrelevant] {
            display: none;
        }
    </style>
    <fx-fore xmlns:tei="http://www.tei-c.org/ns/1.0" create-nodes="create-nodes" id="metadata-panel" ignore-expressions="fx-function">
        <fx-model>
            <!-- This will be filled with the teiHeader element -->
            <fx-instance id="default"></fx-instance>

            <fx-instance id="date-scratchpad"><data mode=""></data></fx-instance>

            <fx-bind ref="instance('date-scratchpad')/*:date">
                <fx-bind ref="@from" required="../@to[string()] => trace('from')"></fx-bind>
                <fx-bind ref="@notAfter" required="../@notAfter[string()] => trace('notAfter')"></fx-bind>
                <fx-bind ref="@notBefore" required="../@notAfter[string()] => trace('notBefore')"></fx-bind>
                <fx-bind ref="@to" required="../@from[string()] => trace('to')"></fx-bind>
                <fx-bind ref="@when"></fx-bind>
            </fx-bind>
        </fx-model>

        <fx-function signature="remove-attributes($element as element())" type="text/xquf">
            let $attrNamesToDelete := switch(instance('date-scratchpad')/@mode) case 'when' return ('notBefore',
            'notAfter', 'from', 'to') case 'from' return ('when', 'notBefore', 'notAfter') case 'notBefore' return
            ('when', 'from', 'to') default return () return copy $xml := $element modify ( for $attr in $xml/@*[name() =
            $attrNamesToDelete] return delete node $attr) return $xml
        </fx-function>

        <fx-function signature="add-attributes($element as element(), $attrNamesToAdd as xs:string*)" type="text/xquf">
            copy $xml := $element modify ( for $attr in $attrNamesToAdd where not($attr = $xml/@*/name()) return insert
            node attribute {$attr} {} into $xml) return $xml
        </fx-function>

        <fx-action event="model-construct-done" id="on-init">
            <fx-insert
                ref="instance('date-scratchpad')/data"
                origin="instance('default')//*:date => add-attributes(('from', 'to', 'notBefore', 'notAfter', 'when'))"
                keep-values="keep-values"
            ></fx-insert>
            <fx-setvalue
                ref="instance('date-scratchpad')/@mode"
                value="(instance('default')//*:date/(@when, @to, @notBefore)/name(), 'when') => head()"
            ></fx-setvalue>
            <fx-refresh force="true"></fx-refresh>
        </fx-action>

        <label>Title<fx-control ref="instance('default')//*:titleStmt/*:title"></fx-control></label>

        <fx-group ref="instance('default')/*:profileDesc/*:settingDesc/*:setting/*:date">
            <label>
                Date format
                <fx-switch ref="instance('date-scratchpad')/@mode">
                    <nav>
                        <details class="dropdown">
                            <summary>{instance('date-scratchpad')/@mode}</summary>
                            <ul>
                                <li>
                                    <fx-trigger>
                                        <a
                                            class="secondary"
                                            href="#"
                                            onclick="this.closest('details').removeAttribute('open')"
                                            >When</a
                                        >
                                        <fx-setvalue ref="." value="'when'"></fx-setvalue>
                                        <fx-replace
                                            ref="instance('default')//*:date"
                                            with="remove-attributes(instance('date-scratchpad')//*:date)"
                                        >
                                        </fx-replace>
                                        <fx-refresh force="true"></fx-refresh>
                                    </fx-trigger>
                                </li>
                                <li>
                                    <fx-trigger>
                                        <a
                                            class="secondary"
                                            href="#"
                                            onclick="this.closest('details').removeAttribute('open')"
                                            >From / To</a
                                        >
                                        <fx-setvalue ref="." value="'from'"></fx-setvalue>
                                        <fx-replace
                                            ref="instance('default')//*:date"
                                            with="remove-attributes(instance('date-scratchpad')//*:date)"
                                        >
                                        </fx-replace
                                        ><fx-refresh force="true"></fx-refresh>
                                    </fx-trigger>
                                </li>
                                <li>
                                    <fx-trigger>
                                        <a
                                            class="secondary"
                                            href="#"
                                            onclick="this.closest('details').removeAttribute('open')"
                                            >Not before / Not after</a
                                        >
                                        <fx-setvalue ref="." value="'notBefore'"></fx-setvalue>
                                        <fx-replace
                                            ref="instance('default')//*:date"
                                            with="remove-attributes(instance('date-scratchpad')//*:date)"
                                        >
                                        </fx-replace
                                        ><fx-refresh force="true"></fx-refresh>
                                    </fx-trigger>
                                </li>
                            </ul>
                        </details>
                    </nav>

                    <fx-case name="when" id="when">
                        <fieldset>
                            <fx-group ref="instance('date-scratchpad')/*:date">
                                <label>
                                    When
                                    <fx-control style="display: block" update-event="change" ref="@when">
                                        <jinntap-datetime data-default-timezone="-5:00" class="widget">
                                        </jinntap-datetime>
                                    </fx-control>
                                </label>
                            </fx-group>
                            <!-- Copy the date, without irrelevant attributes into the correct instance -->
                            <fx-action event="change">
                                <fx-replace
                                    ref="instance('default')//*:date"
                                    with="remove-attributes(instance('date-scratchpad')//*:date)"
                                >
                                </fx-replace>
                                <fx-refresh force="true"></fx-refresh
                            ></fx-action>
                        </fieldset>
                    </fx-case>

                    <fx-case name="notBefore" id="notBefore">
                        <fx-group ref="instance('date-scratchpad')/*:date">
                            <fieldset>
                                <label>
                                    Not before
                                    <fx-control style="display: block" update-event="change" ref="@notBefore">
                                        <jinntap-datetime data-default-timezone="-5:00" class="widget">
                                        </jinntap-datetime>
                                    </fx-control>
                                </label>
                                <label>
                                    Not after
                                    <fx-control style="display: block" update-event="change" ref="@notAfter">
                                        <jinntap-datetime data-default-timezone="-5:00" class="widget">
                                        </jinntap-datetime>
                                    </fx-control>
                                </label>
                            </fieldset>
                            <!-- Copy the date, without irrelevant attributes into the correct instance -->
                            <fx-action event="change">
                                <fx-replace
                                    ref="instance('default')//*:date"
                                    with="remove-attributes(instance('date-scratchpad')//*:date)"
                                >
                                </fx-replace>
                                <fx-refresh force="true"></fx-refresh>
                            </fx-action>
                        </fx-group>
                    </fx-case>

                    <fx-case name="from" id="from">
                        <fx-group ref="instance('date-scratchpad')/*:date">
                            <fieldset>
                                <label>
                                    From
                                    <fx-control style="display: block" update-event="change" ref="@from">
                                        <jinntap-datetime data-default-timezone="-5:00" class="widget">
                                        </jinntap-datetime>
                                    </fx-control>
                                </label>
                                <label>
                                    To
                                    <fx-control style="display: block" update-event="change" ref="@to">
                                        <jinntap-datetime data-default-timezone="-5:00" class="widget">
                                        </jinntap-datetime>
                                    </fx-control>
                                </label>

                                <!-- Copy the date, without irrelevant attributes into the correct instance -->
                                <fx-action event="change">
                                    <fx-replace
                                        ref="instance('default')//*:date"
                                        with="remove-attributes(instance('date-scratchpad')//*:date)"
                                    >
                                    </fx-replace>
                                    <fx-refresh force="true"></fx-refresh>
                                </fx-action>
                            </fieldset>
                        </fx-group>
                    </fx-case>
                </fx-switch>
                <label>
                    Calendar
                    <fx-control ref="@calendar" update-event="change" style="display: block">
                        <select class="widget">
                            <option value="gregorian">Gregorian</option>
                            <option value="julian">Julian</option>
                        </select>
                    </fx-control>
                </label>
            </label>
        </fx-group>
    </fx-fore>
	</div>
    [% endif %]
	[% endtemplate %]
</template>
