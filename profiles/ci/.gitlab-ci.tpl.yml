# GitLab CI configuration for TEI Publisher applications

stages:
  - build
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  ANT_OPTS: "-Djava.io.tmpdir=$CI_PROJECT_DIR/tmp"
  EXIST_VERSION: "6.4.0"
  JAVA_VERSION: "11"
  EXPERIMENTAL: "false"

cache:
  paths:
    - .m2/repository/
    - node_modules/

# Speed up apt-get installs
.speed_up_apt: &speed_up_apt
  - echo 'set man-db/auto-update false' | debconf-communicate >/dev/null
  - dpkg-reconfigure -f noninteractive man-db

# Base build template
.build_template: &build_template
  stage: build
  before_script:
    - *speed_up_apt
    - apt-get update -qq && apt-get install -y -qq ant libxml2-utils bats docker.io curl
    - curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
    - apt-get install -y nodejs
    - systemctl start docker || true
  script:
    # Validate XML files
    - xmllint --noout $(find . -type f -name '*.xml')
    # Build with Ant
    - ant
    # Set up Docker Buildx
    - docker buildx create --use --name builder || docker buildx use builder
    - docker buildx inspect --bootstrap
    # Build Docker image with buildx
    - |
      export DOCKER_BUILDKIT=1
[% if exists($docker?externalXar) and map:size($docker?externalXar) > 0 and (some $fileName in map:keys($docker?externalXar) satisfies ($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token))) and not(every $fileName in map:keys($docker?externalXar) satisfies (not($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token)) or $docker?externalXar($fileName)?token = "CI_JOB_TOKEN")) %]
[% for $fileName in map:keys($docker?externalXar) %]
[% if ($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token) and $docker?externalXar($fileName)?token != "CI_JOB_TOKEN") %]
      export [[ string($docker?externalXar($fileName)?token) ]]="${[[ string($docker?externalXar($fileName)?token) ]]}"
[% endif %]
[% endfor %]
[% endif %]
      docker buildx build \
        --build-arg EXIST_VERSION=${EXIST_VERSION} \
        --build-arg BUILD=local \
        --load \
[% if exists($docker?externalXar) and map:size($docker?externalXar) > 0 and (some $fileName in map:keys($docker?externalXar) satisfies ($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token))) and (every $fileName in map:keys($docker?externalXar) satisfies (not($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token)) or $docker?externalXar($fileName)?token = "CI_JOB_TOKEN")) %]
        --secret id=CI_JOB_TOKEN,env=CI_JOB_TOKEN \
[% else if exists($docker?externalXar) and map:size($docker?externalXar) > 0 and (some $fileName in map:keys($docker?externalXar) satisfies ($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token))) %]
[% for $fileName in map:keys($docker?externalXar) %]
[% if ($docker?externalXar($fileName) instance of map(*) and exists($docker?externalXar($fileName)?token)) %]
        --secret id=[[ string($docker?externalXar($fileName)?token) ]],env=[[ string($docker?externalXar($fileName)?token) ]] \
[% endif %]
[% endfor %]
[% endif %]
        -t ${CI_PROJECT_NAME}-ci:${EXIST_VERSION} \
        .
    # Save Docker image as tar artifact for test job
    - |
      docker save ${CI_PROJECT_NAME}-ci:${EXIST_VERSION} -o docker-image-${EXIST_VERSION}.tar
    # Start eXist-db container
    - |
      docker run -dit -p 8080:[[ $docker?ports?http ]] \
        --name exist --rm --health-interval=1s --health-start-period=2s \
        ${CI_PROJECT_NAME}-ci:${EXIST_VERSION}
    # Wait for server to start
    - |
      echo "Waiting for server to start..."
      timeout=60
      elapsed=0
      while [ $elapsed -lt $timeout ]; do
        if docker logs exist 2>&1 | grep -q "Server has started"; then
          echo "Server started!"
          break
        fi
        echo "Still waiting... ($elapsed/$timeout seconds)"
        sleep 4
        elapsed=$((elapsed + 4))
      done
    # Debug logs (non-failing step)
    - |
      echo "=== Checking for errors ==="
      docker logs exist 2>&1 | grep 'ERROR' || echo "No ERROR messages found"
  after_script:
    # Copy logs on failure
    - |
      if [ "$CI_JOB_STATUS" = "failed" ]; then
        echo "=== Copying logs ==="
        docker cp exist:/exist/logs/exist.log ./exist.log 2>/dev/null || true
      fi
  artifacts:
    paths:
      - build/*.xar
      - exist.log
      - docker-image-*.tar
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master")
    - if: $CI_PIPELINE_SOURCE == "push"

# Base test template
.test_template: &test_template
  stage: test
  needs:
    - job: build
      artifacts: true
  image: cypress/browsers:latest
  services:
    - docker:dind
  before_script:
    - *speed_up_apt
    - apt-get update -qq && apt-get install -y -qq bats docker.io curl
    - curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
    - apt-get install -y nodejs
    - systemctl start docker || true
    # Load Docker image from build job artifact
    - |
      docker load -i docker-image-${EXIST_VERSION}.tar
    # Start eXist-db container using built image from build job
    - |
      docker run -dit -p 8080:[[ $docker?ports?http ]] \
        --name exist --rm --health-interval=1s --health-start-period=2s \
        ${CI_PROJECT_NAME}-ci:${EXIST_VERSION}
    # Wait for server to start
    - |
      echo "Waiting for server to start..."
      timeout=60
      elapsed=0
      while [ $elapsed -lt $timeout ]; do
        if docker logs exist 2>&1 | grep -q "Server has started"; then
          echo "Server started!"
          break
        fi
        echo "Still waiting... ($elapsed/$timeout seconds)"
        sleep 4
        elapsed=$((elapsed + 4))
      done
  script:
    # Run BATS tests
    - bats --tap test/*.bats
    # Debug logs after BATS tests (non-failing step)
    - |
      echo "=== Checking for errors after BATS tests ==="
      docker logs exist 2>&1 | grep 'ERROR' || echo "No ERROR messages found"
    # Run Cypress tests
    - |
      if [ "$EXPERIMENTAL" = "true" ]; then
        npx cypress run --browser firefox || true
      else
        npx cypress run --browser firefox
      fi
    # Debug logs after Cypress tests (non-failing step)
    - |
      echo "=== Checking for errors after Cypress tests ==="
      docker logs exist 2>&1 | grep 'ERROR' || echo "No ERROR messages found"
  after_script:
    # Copy logs on failure
    - |
      if [ "$CI_JOB_STATUS" = "failed" ]; then
        echo "=== Copying logs ==="
        docker cp exist:/exist/logs/exist.log ./exist.log 2>/dev/null || true
      fi
  artifacts:
    when: on_failure
    paths:
      - test/cypress/screenshots/
      - test/cypress/videos/
      - exist.log
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master")
    - if: $CI_PIPELINE_SOURCE == "push"
  allow_failure:
    variable: EXPERIMENTAL
    value: "true"

# Build jobs - parallel execution for different configurations
build:6.4.0:java11:
  <<: *build_template
  image: openjdk:11-jdk-slim
  variables:
    EXIST_VERSION: "6.4.0"
    JAVA_VERSION: "11"
    EXPERIMENTAL: "false"

build:release:java11:
  <<: *build_template
  image: openjdk:11-jdk-slim
  variables:
    EXIST_VERSION: "release"
    JAVA_VERSION: "11"
    EXPERIMENTAL: "false"

build:latest:java21:
  <<: *build_template
  image: openjdk:21-jdk-slim
  variables:
    EXIST_VERSION: "latest"
    JAVA_VERSION: "21"
    EXPERIMENTAL: "true"

# Test jobs - parallel execution matching build jobs
test:6.4.0:java11:
  <<: *test_template
  variables:
    EXIST_VERSION: "6.4.0"
    JAVA_VERSION: "11"
    EXPERIMENTAL: "false"
  needs:
    - job: build:6.4.0:java11
      artifacts: true

test:release:java11:
  <<: *test_template
  variables:
    EXIST_VERSION: "release"
    JAVA_VERSION: "11"
    EXPERIMENTAL: "false"
  needs:
    - job: build:release:java11
      artifacts: true

test:latest:java21:
  <<: *test_template
  variables:
    EXIST_VERSION: "latest"
    JAVA_VERSION: "21"
    EXPERIMENTAL: "true"
  needs:
    - job: build:latest:java21
      artifacts: true
  allow_failure: true
