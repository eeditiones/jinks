<main class="editor">
    ---json
    {
        "scripts": [
            "resources/scripts/editor.js"
        ],
        "templating": {
            "extends": "pages/page.html"
        }
    }
    ---
    [% template before %]
    <div class="apps-aside">
        <nav>
            <ul>
                <li>
                    <button id="reset" type="reset">
                        <svg class="icon"><use href="#icon-new"></use></svg>
                        <span>New Config</span>
                    </button>
                </li>
            </ul>
        </nav>
        <ul class="installed"></ul>
    </div>
    [% endtemplate %]

    [% template after-top-heading %]
    <li><h3>JSON Configuration</h3></li>
    [% endtemplate %]

    [% template content-top %]
    <nav class="tabs">
        <ul>
            <li><a href="#config" data-shortcut="ctrl+1,alt+1">Application Configuration</a></li>
            <li><a href="#profiles" data-shortcut="ctrl+2,alt+2">Profiles</a></li>
            <li><a href="#theming" data-shortcut="ctrl+3,alt+3">Theming</a></li>
        </ul>
    </nav>
    [% endtemplate %]

    <form id="config">
        <section id="configMeta" data-tab="config">
            <fieldset>
                <label>
                    Abbreviation
                    <input type="text" name="abbrev" placeholder="Abbreviation" required="" pattern="[\w\-_]+"/>
                    <small>Unique name to identify the app. Only characters and -, _</small>
                </label>
                <label>
                    Label
                    <input type="text" name="label" placeholder="Short title" required=""/>
                    <small>Descriptive title</small>
                </label>
                <label>
                    Unique identifier
                    <input type="url" name="id" placeholder="URI" required=""/>
                    <small>Unique URL to identify the app</small>
                </label>
            </fieldset>

            <fieldset role="group">
                <input type="text" class="action" name="custom-odd" placeholder="my-odd.odd" pattern="[\w\-_]+\.odd" />
                <button id="add-odd" class="secondary">Add</button>
            </fieldset>
            <small>Set the filename for a new custom ODD for the app.</small>

            <fieldset>
                <label>
                    Operation mode
                    <select id="overwrite" name="overwrite" placeholder="Overwrite mode">
                        <option value="quick">Quick update</option>
                        <option value="all">All: check every file for changes</option>
                        <option value="reinstall">Factory reset: reinstall everything</option>
                    </select>
                    <small>Modes <strong>quick update</strong> and <strong>all</strong> will never overwrite local changes.
                        <strong>Quick update</strong> mode is faster if applied repeatedly, but
                        won't list local changes unless they conflict with incoming updates. For a full list of updates and
                        conflicts, use <strong>all</strong>.</small>
                </label>
            </fieldset>
            <nav>
                <ul>
                    <li>
                        <button class="apply-config" data-tooltip="Apply configuration" data-shortcut="cmd+shift+s,ctrl+shift+s">
                            <svg class="icon">
                                <use href="#icon-refresh"></use>
                            </svg>
                            <span>Apply</span>
                        </button>
                    </li>
                    <!--li>
                        <button id="dry-run" class="secondary" data-tooltip="Dry run: show changes without applying them">Dry
                            Run</button>
                    </li-->
                    <li>
                        <span id="spinner" aria-busy="true">Applying configuration...</span>
                    </li>
                </ul>
            </nav>
            <details id="action-details" style="display: none;">
                <summary>Actions</summary>
                <nav>
                    <ul id="actions" class="buttons"></ul>
                </nav>
            </details>
            <hr/>
        </section>
        <section id="profiles" class="profiles" data-tab="profiles">
            <fieldset>
                <legend>Blueprints</legend>
                <ul>
                    [% for $profile in filter($context?profiles, function($p) { $p?type = "blueprint"}) %]
                    <li>
                        <label data-tooltip="[[ $profile?description ]]" data-placement="right">
                            <input type="checkbox" name="blueprint" value="[[ $profile?path ]]"
                                data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]" />
                            [[ $profile?label ]]
                        </label>
                        <a href="profile/[[ $profile?path ]]" target="jinks-profile-documentation">
                            <svg class="icon">
                                <use href="#icon-information"></use>
                            </svg>
                        </a>
                    </li>
                    [% endfor %]
                </ul>
            </fieldset>
            <fieldset>
                <legend>Base Profile</legend>
                <ul>
                [% let $baseProfiles = filter($context?profiles, function($p) { $p?type = "base"}) %]
                [% for $profile in $baseProfiles %]
                <li>
                    <label data-tooltip="[[ $profile?description ]]"
                        data-placement="right">
                        [% if $profile?path = head($baseProfiles)?path %]
                        <input type="radio" name="base" value="[[ $profile?path ]]" checked=""
                            data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]"/>
                        [% else %]
                        <input type="radio" name="base" value="[[ $profile?path ]]" 
                            data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]"/>
                        [% endif %]
                        [[ $profile?label ]]
                    </label>
                    <a href="profile/[[ $profile?path ]]" target="jinks-profile-documentation">
                        <svg class="icon">
                            <use href="#icon-information"></use>
                        </svg>
                    </a>
                </li>
                [% endfor %]
                [% endlet %]
                </ul>
            </fieldset>

            <fieldset>
                <legend>Features</legend>
                [% for $category in sort(distinct-values(for-each($context?profiles, function($p) { $p?category })))  %]
                <div>
                    <h4><pb-i18n key="categories.[[ $category ]]">[[ $category ]]</pb-i18n></h4>
                    <ul>
                    [% for $profile in filter($context?profiles, function($p) { $p?type = "feature" and $p?category = $category }) %]
                    <li>
                        <label data-tooltip="[[ $profile?description ]]"
                            data-placement="right">
                            <input type="checkbox" name="feature" value="[[ $profile?path ]]"
                                data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]"/>
                            [[ $profile?label ]]
                        </label>
                        <a href="profile/[[ $profile?path ]]" target="jinks-profile-documentation">
                            <svg class="icon"><use href="#icon-information"></use></svg>
                        </a>
                    </li>
                    [% endfor %]
                    </ul>
                </div>
                [% endfor %]
            </fieldset>
        </section>

        <section data-tab="theming">
            <fieldset>
                <legend>Themes</legend>
                <ul>
                    [% let $themeProfiles = filter($context?profiles, function($p) { $p?type = "theme"}) %]
                    [% for $profile in $themeProfiles %]
                    <li>
                        <label data-tooltip="[[ $profile?description ]]" data-placement="right">
                            [% if $profile?path = tail($themeProfiles)?path %]
                            <input type="checkbox" name="theme" value="[[ $profile?path ]]" checked=""
                                data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]" />
                            [% else %]
                            <input type="checkbox" name="theme" value="[[ $profile?path ]]"
                                data-depends="[[ serialize($profile?depends, map { 'method': 'json'}) ]]" />
                            [% endif %]
                            [[ $profile?label ]]
                        </label>
                        <a href="profile/[[ $profile?path ]]" target="jinks-profile-documentation">
                            <svg class="icon">
                                <use href="#icon-information"></use>
                            </svg>
                        </a>
                    </li>
                    [% endfor %]
                    [% endlet %]
                </ul>
            </fieldset>
            
            <fieldset>
                <legend>Color Scheme</legend>
                <div class="color-scheme-picker" id="color-scheme-picker">
                    <!-- Dynamically populated -->
                </div>
            </fieldset>
        </section>
    </form>
    <section id="configEditor">
        <jinn-monaco-editor id="appConfig" value="{}"
            schema="[[ $config:context-path ]]/schema/jinks.json"></jinn-monaco-editor>
        <details>
            <summary>Merged Configuration</summary>
            <jinn-monaco-editor id="mergedConfig" language="json" readonly="" value="{}"></jinn-monaco-editor>
        </details>
    </section>
    [% template dialogs %]
    <pb-message id="message-dialog"></pb-message>
    <pb-dialog id="output-dialog">
        <h3 slot="title">Command Output</h3>
        <section id="output">
            <ul class="output"></ul>
            <div class="error"></div>
        </section>
        <nav slot="footer">
            <ul>
                <li>
                    <button id="resolve-all" data-tooltip="Mark all conflicts as resolved" data-placement="right">
                        <svg class="icon">
                            <use href="#icon-resolve"></use>
                        </svg>
                        <span>Resolve All</span>
                    </button>
                </li>
                <li>
                    <button class="apply-config" data-tooltip="Re-apply configuration after resolving conflicts" data-shortcut="cmd+shift+s,ctrl+shift+s" style="display: none;">
                        <svg class="icon">
                            <use href="#icon-refresh"></use>
                        </svg>
                        <span>Re-apply</span>
                    </button>
                </li>
            </ul>
            <ul>
                <li>
                    <button autofocus="autofocus" rel="prev" aria-label="Close">
                        <svg class="icon">
                            <use href="#icon-close"></use>
                        </svg>
                        <span><pb-i18n key="dialogs.close">Close</pb-i18n></span>
                    </button>
                </li>
            </ul>
        </nav>
    </pb-dialog>
    [% endtemplate %]
</main>
